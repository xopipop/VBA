# VBA-модули для Excel

Этот репозиторий содержит набор готовых модулей VBA, позволяющих быстро подключить систему прав доступа и журналирования в любую книгу Excel.

## Импорт модулей

1. **Включите макросы** в Excel:
   - Откройте **Файл** → **Параметры** → **Центр управления безопасностью**.
   - В окне **Параметры Центра управления безопасностью** разрешите использование макросов.
2. **Откройте редактор VBA** клавишами `Alt + F11`.
3. **Импортируйте файлы** из папки `src` этого репозитория:
   - В обозревателе проекта выберите книгу, щёлкните правой кнопкой мыши и нажмите **Импорт файла...**.
   - Укажите `Permissions.bas`, `Logging.bas`, `Utility.bas`, `frmLogin.frm` и `ThisWorkbook.cls`.
4. Сохраните книгу как файл с поддержкой макросов (`.xlsm`).

## Модули

- **Permissions** – управление доступом к листам и диапазонам, а также восстановление заблокированных ячеек.
- **Logging** – ведёт журналы входов пользователей и изменений данных.
- **Utility** – функции общего назначения: проверка наличия листов, чтение пароля, начальная подготовка рабочих листов.
- **frmLogin** – форма авторизации пользователей и управления списком пользователей.

### Пример кода в `ThisWorkbook`
```vba
Private Sub Workbook_Open()
    InitializeGlobals
    frmLogin.Show
    If frmLogin.IsAuthenticated Then
        Dim info As Variant
        info = frmLogin.UserInfo
        ApplyPermissions frmLogin.Username, info(1), info(2), info(3)
        LogLogin frmLogin.Username, "open", ""
    Else
        ThisWorkbook.Close False
    End If
End Sub

Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    LogChangeForCell Target, ""
End Sub
```

## Вспомогательные листы

- **"ПраваДоступа"** – таблица пользователей. Столбцы: имя, пароль, роль, доступные листы, разрешённые диапазоны.
- **"ЛогВхода"** – журнал входов. Хранит время, пользователя, результат и комментарий.
- **"ЛогИзменений"** – журнал правок. Фиксирует время, пользователя, лист, адрес, старое и новое значения.
- **"LockedCells"** – список заблокированных ячеек (скрыт). Используется для восстановления защиты при открытии книги.

## Лицензия

Проект распространяется на условиях [Unlicense](LICENSE).

## Вклад

Мы приветствуем улучшения и исправления. Создайте issue или отправьте pull request.
