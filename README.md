# VBA-модули для Excel

Этот репозиторий содержит набор готовых модулей VBA, позволяющих быстро подключить систему прав доступа и журналирования в любую книгу Excel.

## Импорт модулей

1. **Включите макросы** в Excel:
   - Откройте **Файл** → **Параметры** → **Центр управления безопасностью**.
   - В окне **Параметры Центра управления безопасностью** разрешите использование макросов.
2. **Откройте редактор VBA** клавишами `Alt + F11`.
3. **Импортируйте файлы** из папки `src` этого репозитория:
   - В обозревателе проекта выберите книгу, щёлкните правой кнопкой мыши и нажмите **Импорт файла...**.
   - Укажите `Permissions.bas`, `Logging.bas` и `Utility.bas`.
4. Сохраните книгу как файл с поддержкой макросов (`.xlsm`).

## Импорт формы входа

1. В редакторе VBA щелкните правой кнопкой мыши по книге и выберите **Импорт файла...**.
2. Укажите файл формы `LoginForm.frm` из папки `src` (если форма поставляется отдельно, поместите ее туда).
3. После импорта форма появится в списке объектов проекта и ее можно вызывать из кода.

### Куда поместить обработчики событий

Код обработки открытия книги и отслеживания изменений размещается в модуле `ThisWorkbook`. Пример ниже можно вставить в этот модуль без изменений.

## Модули

- **Permissions** – управление доступом к листам и диапазонам, а также восстановление заблокированных ячеек.
- **Logging** – ведёт журналы входов пользователей и изменений данных.
- **Utility** – функции общего назначения: проверка наличия листов, чтение пароля, начальная подготовка рабочих листов.

### Пример кода в `ThisWorkbook`
```vba
Private Sub Workbook_Open()
    InitializeGlobals
    Dim info As Variant
    info = GetUserInfo(Environ("Username"))
    ApplyPermissions Environ("Username"), info(1), info(2), info(3)
    LogLogin Environ("Username"), "open", ""
End Sub

Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    LogChangeForCell Target, ""
End Sub
```

## Вспомогательные листы

- **"ПраваДоступа"** – таблица пользователей. Столбцы:
  1. `A` – имя пользователя.
  2. `B` – пароль (можно оставить пустым).
  3. `C` – роль (`admin` или `user`).
  4. `D` – доступные листы через `;` либо `*` для всех.
  5. `E` – разрешённые диапазоны вида `Sheet!A1:B2`.
- **"ЛогВхода"** – журнал входов. Содержит колонки: время входа, пользователь, результат (`ok` или `fail`), комментарий.
- **"ЛогИзменений"** – журнал правок. Фиксирует время изменения, пользователя, лист, адрес ячейки, старое и новое значения.
- **"LockedCells"** – скрытый лист со списком заблокированных ячеек. Позволяет восстановить защиту при следующем открытии книги.

## Настройка книги

### Для администратора
1. Добавьте свои учётные записи на листе "ПраваДоступа" и укажите роль `admin`.
2. Задайте пароль защиты в ячейке `B1` листа "ПраваДоступа".
3. После установки прав сохраните книгу и раздайте копии пользователям.

### Для пользователя
1. Откройте файл и разрешите выполнение макросов.
2. При появлении формы входа введите имя и пароль.
3. После успешного входа права доступа применяются автоматически.

### Схема работы
```
Пользователь -> форма входа -> проверка на листе "ПраваДоступа"
             -> при успехе вызывается ApplyPermissions
             -> при неудаче выводится сообщение об ошибке
Изменения ячеек -> Logging.bas фиксирует запись в "ЛогИзменений"
```


## Лицензия

Проект распространяется на условиях [Unlicense](LICENSE).

## Вклад

Мы приветствуем улучшения и исправления. Создайте issue или отправьте pull request.
